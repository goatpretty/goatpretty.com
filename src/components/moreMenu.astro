---
interface LinkItem {
  name: string;
  url: string;
}

interface Props {
  links: LinkItem[];
}

const { links } = Astro.props as Props;
---

<!-- âœ… å“åº”å¼ More èœå• -->
<div class="relative select-none">
  <!-- æŒ‰é’®ï¼ˆæ¡Œé¢ç«¯ä¸ºæ–‡å­—ï¼Œç§»åŠ¨ç«¯ä¸º â˜° å›¾æ ‡ï¼‰ -->
  <button
    id="more-toggle"
    class="inline-flex flex-initial p-2 cursor-pointer
           text-fontLight dark:text-fontDark hover:text-phOrange transition
           items-center justify-center"
    aria-label="More menu"
  >
    <!-- æ¡Œé¢ç«¯ -->
    <span class="hidden md:inline">More â–¾</span>

    <!-- ç§»åŠ¨ç«¯ -->
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-6 w-6 md:hidden"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
      stroke-width="2"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
    </svg>
  </button>

  <!-- ðŸ–¥ï¸ æ¡Œé¢ç«¯èœå• -->
  <div
    id="more-dropdown-desktop"
    class="invisible opacity-0 absolute right-0 top-full mt-2 w-48
           bg-bgLight dark:bg-bgDark
           border border-gray-300 dark:border-gray-700
           rounded-xl shadow-xl overflow-hidden z-50
           transform scale-95 transition-all duration-200 ease-out hidden md:block"
  >
    {links.map((link) => (
      <a
        href={link.url}
        target={link.url.startsWith('http') ? '_blank' : '_self'}
        rel="noopener noreferrer"
        class="block px-4 py-2 text-fontLight dark:text-fontDark
               hover:bg-phOrange hover:text-white transition-colors text-center"
      >
        {link.name}
      </a>
    ))}
  </div>

  <!-- ðŸ“± ç§»åŠ¨ç«¯å…¨å±æ¨¡ç³Šèœå• -->
  <div
    id="more-overlay-mobile"
    class="fixed inset-0 bg-black/40 backdrop-blur-md z-[100] hidden md:hidden
           items-center justify-center transition-opacity duration-200 opacity-0"
  >
    <div
      id="more-dropdown-mobile"
      class="bg-bgLight/90 dark:bg-bgDark/90 rounded-2xl shadow-2xl
             border border-gray-300 dark:border-gray-700
             w-64 text-center overflow-hidden transform scale-95 transition-transform duration-200"
    >
      {links.map((link) => (
        <a
          href={link.url}
          target={link.url.startsWith('http') ? '_blank' : '_self'}
          rel="noopener noreferrer"
          class="block px-6 py-3 text-fontLight dark:text-fontDark
                 hover:bg-phOrange hover:text-white transition-colors"
        >
          {link.name}
        </a>
      ))}
      <button
        id="close-menu"
        class="w-full py-3 text-fontLight dark:text-fontDark hover:text-phOrange transition"
      >
        Close âœ•
      </button>
    </div>
  </div>

  <script>
    // âœ… ä¸¥æ ¼æ¨¡å¼ + ç±»åž‹å…¼å®¹ä¿®å¤
    const toggleBtn = document.getElementById('more-toggle') as HTMLButtonElement | null;
    const desktopMenu = document.getElementById('more-dropdown-desktop') as HTMLDivElement | null;
    const mobileOverlay = document.getElementById('more-overlay-mobile') as HTMLDivElement | null;
    const mobileMenu = document.getElementById('more-dropdown-mobile') as HTMLDivElement | null;
    const closeBtn = document.getElementById('close-menu') as HTMLButtonElement | null;

    let isOpen = false;

    const isDesktop = () => window.innerWidth >= 768;

    const openDesktop = () => {
      if (!desktopMenu) return;
      desktopMenu.classList.remove('invisible', 'opacity-0', 'scale-95');
      desktopMenu.classList.add('visible', 'opacity-100', 'scale-100');
    };

    const closeDesktop = () => {
      if (!desktopMenu) return;
      desktopMenu.classList.add('opacity-0', 'scale-95');
      desktopMenu.classList.remove('opacity-100', 'scale-100');
      setTimeout(() => desktopMenu.classList.add('invisible'), 180);
    };

    const openMobile = () => {
      if (!mobileOverlay || !mobileMenu) return;
      mobileOverlay.classList.remove('hidden');
      requestAnimationFrame(() => {
        mobileOverlay.classList.add('flex');
        mobileOverlay.style.opacity = '1';
        mobileMenu.style.transform = 'scale(1)';
      });
    };

    const closeMobile = () => {
      if (!mobileOverlay || !mobileMenu) return;
      mobileOverlay.style.opacity = '0';
      mobileMenu.style.transform = 'scale(0.95)';
      setTimeout(() => {
        mobileOverlay.classList.add('hidden');
        mobileOverlay.classList.remove('flex');
      }, 180);
    };

    if (toggleBtn) {
      toggleBtn.addEventListener('click', (e: MouseEvent) => {
        e.stopPropagation();
        if (isDesktop()) {
          isOpen ? closeDesktop() : openDesktop();
        } else {
          isOpen ? closeMobile() : openMobile();
        }
        isOpen = !isOpen;
      });
    }

    // âœ… ä¿®å¤ TS æŠ¥é”™çš„äº‹ä»¶ç±»åž‹ï¼ˆEventTarget â†’ Nodeï¼‰
    document.addEventListener('click', (e: MouseEvent) => {
      const target = e.target as Node | null;
      if (!isDesktop() || !desktopMenu || !toggleBtn) return;
      if (target && !desktopMenu.contains(target) && !toggleBtn.contains(target)) {
        closeDesktop();
        isOpen = false;
      }
    });

    mobileOverlay?.addEventListener('click', (e: MouseEvent) => {
      if (e.target === mobileOverlay) {
        closeMobile();
        isOpen = false;
      }
    });

    closeBtn?.addEventListener('click', () => {
      closeMobile();
      isOpen = false;
    });

    document.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        if (isDesktop()) closeDesktop();
        else closeMobile();
        isOpen = false;
      }
    });

    window.addEventListener('resize', () => {
      closeDesktop();
      closeMobile();
      isOpen = false;
    });
  </script>
</div>
