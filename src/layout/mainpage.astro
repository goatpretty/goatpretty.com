---
import config from '../../config';
import Github from '../components/icons/github.astro';
import Mail from '../components/icons/mail.astro';
import FriendLink from '../components/friendLink.astro';
import Post from '../components/icons/post.astro';
import Tag from '../components/icons/tag.astro';
import Avatar from '../components/avatar.astro';
import GoBackToTop from '../components/goBackToTop.astro';
import * as motion from 'motion/react-client';
import { getCollection } from 'astro:content';
import '../styles/global.css';

const posts = await getCollection('posts');
const totalPosts = posts.length;
let tags = new Set();
posts.map((post: any) => {
  post.data.tags.map((tag: string) => {
    tags.add(tag);
  });
});
const totalTags = tags.size;
---

<!-- ‚úÖ ÊèêÂâçÈ¢ÑÂä†ËΩΩÂæÆ‰ø°Êî∂Ê¨æÁ†ÅÂõæÁâá -->
<link rel="preload" as="image" href={config.wechat_qr}>

<body class="bg-bodyLight dark:bg-bodyDark flex flex-col h-screen overflow-hidden">
  <slot name="header" />
  <main class="flex flex-1 flex-col md:flex-row overflow-y-scroll" id="main-content-main">
    <div class="md:bg-bgLight md:dark:bg-bgDark flex flex-auto flex-col md:w-3/12 md:pl-16">
      <motion.div
        client:load
        initial={{ opacity: 0, x: -50 }}
        animate={{ opacity: 1, x: 0 }}
        transition={{ duration: 0.4 }}
      >
        <!-- foil -->
        <div
          class="bg-foilLight dark:bg-foilDark flex flex-col items-center
                 mt-2 md:ml-8 md:mr-4 ml-4 mr-4 pt-2 rounded-2xl"
        >
          <!-- avatar -->
          <Avatar src={config.avatar} alt="avatar" />
          <p class="text-profileTextLight dark:text-profileTextDark text-2xl mt-2 italic">
            {config.author}
          </p>
          <p class="text-descriptionTextLight dark:text-descriptionTextDark text-bg italic">
            ---- {config.author_description}
          </p>

          <!-- Â∏ñÂ≠êÁªüËÆ° -->
          <div class="flex flex-row w-full justify-around mt-4 mb-4 text-2xl text-profileTextLight dark:text-profileTextDark">
            <div class="flex flex-col items-center">
              <div><Post class="w-9 h-9" /></div>
              <p class="text-3xl">{totalPosts}</p>
            </div>
            <div class="flex flex-col items-center">
              <div><Tag class="w-9 h-9" /></div>
              <p class="text-3xl">{totalTags}</p>
            </div>
          </div>

          <!-- üß© GitHub + E-mail -->
          <div class="flex flex-row w-full mb-2 justify-around text-bg text-profileTextLight dark:text-profileTextDark">
            <a
              href={config.github}
              target="_blank"
              class="inline-flex w-2/5 justify-center items-center hover:bg-bgLight dark:hover:bg-bgDark rounded-md"
            >
              <Github class="h-6 w-6 mr-1" />
              GitHub
            </a>
            <a
              href={`mailto:${config.email}?subject=${config.email_subject}`}
              class="inline-flex w-2/5 justify-center items-center hover:bg-bgLight dark:hover:bg-bgDark rounded-md"
            >
              <Mail class="h-6 w-6 mr-1" />
              E-Mail
            </a>
          </div>

          <!-- üÜï Douyin + Bilibili -->
          <div class="flex flex-row w-full mb-4 justify-around text-bg text-profileTextLight dark:text-profileTextDark">
            <a
              href={config.douyin}
              target="_blank"
              class="inline-flex w-2/5 justify-center items-center hover:bg-bgLight dark:hover:bg-bgDark rounded-md"
            >
              <img src="/douyin.svg" alt="Douyin" class="w-7 h-7 mr-1" />
              Douyin
            </a>
            <a
              href={config.bilibili}
              target="_blank"
              class="inline-flex w-2/5 justify-center items-center hover:bg-bgLight dark:hover:bg-bgDark rounded-md"
            >
              <img src="/bilibili.svg" alt="Bilibili" class="w-7 h-7 mr-1" />
              Bilibili
            </a>
          </div>

          <!-- üí¨ WeChat ÁÇπÂáªÂºπÂá∫‰∫åÁª¥Á†Å -->
          <div class="relative flex justify-center mb-6 w-full">
            <div
              id="wechat-container"
              class="inline-flex justify-center items-center cursor-pointer
                     text-bg text-profileTextLight dark:text-profileTextDark
                     hover:text-phOrange select-none"
            >
              <img src="/wechat.svg" alt="WeChat" class="w-7 h-7 mr-1" />
              WeChat
            </div>
          </div>
        </div>

        <FriendLink />
      </motion.div>
    </div>

    <div class="flex-auto md:w-8/12 md:ml-0.5 md:mr-0.5 ml-2 mr-2 md:overflow-y-scroll" id="main-content-div">
      <slot name="main" />
    </div>

    <div class="bg-bgLight dark:bg-bgDark flex-auto w-2/12 hidden md:block">
      <div class="flex justify-center">
        <p class="italic text-descriptionTextLight dark:text-descriptionTextDark">
          Posts grows here~
        </p>
      </div>
    </div>

    <GoBackToTop />
  </main>

  <!-- üí¨ WeChat Ê®°ÊÄÅÂºπÁ™ó -->
  <div
    id="wechat-modal"
    class="fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm hidden items-center justify-center z-50 transition-opacity duration-200 opacity-0"
  >
    <div
      id="wechat-popup"
      class="bg-white dark:bg-bgDark p-5 rounded-2xl shadow-2xl transform scale-95 transition-all duration-200 max-w-xs flex flex-col items-center"
    >
      <img
        src={config.wechat_qr}
        alt="WeChat QR"
        class="max-w-[320px] w-full h-auto object-contain rounded-xl select-none"
      />
      <p class="text-center text-sm text-fontLight dark:text-fontDark mt-3">Êâ´Á†ÅÊ∑ªÂä† / ÊîØÊåÅ‰ΩúËÄÖ</p>
    </div>
  </div>
</body>

<script>
  const setMainContentId = () => {
    const mainElement = document.getElementById('main-content-main');
    const specificDivElement = document.getElementById('main-content-div');
    if (window.innerWidth >= 768) {
      specificDivElement?.setAttribute('id', 'main-content');
      mainElement?.removeAttribute('id');
    } else {
      mainElement?.setAttribute('id', 'main-content');
      specificDivElement?.removeAttribute('id');
    }
  };
  window.onload = setMainContentId;
  window.addEventListener('resize', setMainContentId);

  // üí¨ WeChat ÂºπÁ™óÈÄªËæë
  const wechatBtn = document.getElementById('wechat-container');
  const modal = document.getElementById('wechat-modal');
  const popup = document.getElementById('wechat-popup');

  if (wechatBtn && modal && popup) {
    wechatBtn.addEventListener('click', () => {
      modal.classList.remove('hidden');
      requestAnimationFrame(() => {
        modal.classList.add('flex');
        modal.style.opacity = '1';
        popup.style.transform = 'scale(1)';
      });
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.opacity = '0';
        popup.style.transform = 'scale(0.95)';
        setTimeout(() => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        }, 200);
      }
    });

    // ÊîØÊåÅ ESC ÈîÆÂÖ≥Èó≠
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        modal.style.opacity = '0';
        popup.style.transform = 'scale(0.95)';
        setTimeout(() => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
        }, 200);
      }
    });
  }
</script>
