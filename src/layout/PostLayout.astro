---
import "../styles/global.css";

const { frontmatter, Content } = Astro.props;
---

<html lang="zh-cn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{frontmatter.title}</title>

    <!-- 全局样式 -->
    <link rel="stylesheet" href="/styles/global.css" />

    <!-- 党史随笔 / 自定义样式：放在 global.css 之后，使其能够覆盖 -->
    {frontmatter.customStyle && (
      <link rel="stylesheet" href={frontmatter.customStyle} />
    )}

    <!-- SEO -->
    {frontmatter.description && (
     <meta name="description" content={frontmatter.description} />
    )}
  </head>

  <body>
    <article class="post">
      {frontmatter.title && <h1 class="post-title">{frontmatter.title}</h1>}

      {frontmatter.publishDate && (
        <p class="post-meta">
          <time datetime={frontmatter.publishDate}>
            {frontmatter.publishDate}
          </time>
        </p>
      )}

      {frontmatter.description && (
        <p class="post-description">{frontmatter.description}</p>
      )}

      <!-- 文章内容（党史随笔自动加 .dangshi class） -->
      <div class={`post-content ${frontmatter.customStyle ? 'dangshi' : ''}`}>
        <Content />
      </div>

      <!-- 最后更新时间 + 阅读次数 -->
      <div
        id="meta-info"
        class="text-right text-sm text-fontLight dark:text-fontDark opacity-70 mt-6 select-none"
      >
        {frontmatter.lastUpdated && <>最后更新时间 {frontmatter.lastUpdated}　</>}
        <span id="view-counter">正在统计阅读次数...</span>
      </div>
    </article>

    <!-- 阅读次数脚本 -->
    <script is:inline>
    // @ts-nocheck
    const pathParts = window.location.pathname.split('/');
    const slug = pathParts.filter(Boolean).pop();

    if (slug) {
      const lastViewKey = `viewed_${slug}`;
      const lastViewTime = localStorage.getItem(lastViewKey);
      const now = Date.now();

      const updateCounter = (views) => {
        const el = document.getElementById('view-counter');
        if (el) el.textContent = `阅读 ${views} 次`;
      };

      const showError = () => {
        const el = document.getElementById('view-counter');
        if (el) el.textContent = '阅读统计加载失败';
      };

      if (!lastViewTime || now - Number(lastViewTime) > 24 * 60 * 60 * 1000) {
        fetch(`/views/${slug}`)
          .then((res) => res.json())
          .then((data) => {
            if (data && typeof data.views === 'number') {
              updateCounter(data.views);
              localStorage.setItem(lastViewKey, now.toString());
            } else showError();
          })
          .catch(showError);
      } else {
        fetch(`/views/${slug}`)
          .then((res) => res.json())
          .then((data) => {
            if (data && typeof data.views === 'number') updateCounter(data.views);
            else showError();
          })
          .catch(showError);
      }
    }
    </script>
  </body>
</html>

<style>
.post {
  max-width: 820px;
  margin: 0 auto;
  padding: 2rem 1rem;
}

/* 标题：保持全局一致 */
.post-title {
  font-size: 2.2rem;
  margin: 0 0 0.5rem;
  line-height: 1.3;
  text-align: center;
}

/* 发布日期 */
.post-meta {
  color: #888;
  font-size: 0.9rem;
  text-align: center;
  margin: 0 0 1.5rem;
  text-indent: 0;
}

/* 简介文字 */
.post-description {
  font-size: 1.1rem;
  text-align: center;
  color: #555;
  margin: 0 0 2rem;
  text-indent: 0;
}

/* 默认正文基础样式（不会覆盖 dangshi.css） */
.post-content {
  font-size: 1rem;
  line-height: 1.8;
  color: inherit; /* ⚠ 完全继承，不强制颜色 */
}
</style>
