---
import * as motion from 'motion/react-client';
import FriendLink from '../components/friendLink.astro';
import '../styles/mathjax.css';
import '../styles/global.css';

// âœ… ä» Markdown frontmatter ä¸­è·å– lastUpdated
const { lastUpdated } = Astro.props;
---

<div class="bg-bodyLight dark:bg-bodyDark flex flex-col overflow-hidden h-screen">
  <slot name="header" />
  <main class="flex flex-1">
    <!-- å·¦ä¾§ç›®å½• -->
    <div class="bg-bgLight dark:bg-bgDark hidden md:flex flex-auto flex-col w-3/12 pl-16">
      <motion.div
        client:load
        initial={{ opacity: 0, x: -50 }}
        animate={{ opacity: 1, x: 0 }}
        transition={{
          duration: 0.4,
        }}
      >        
        <div
          class="bg-foilLight dark:bg-foilDark flex flex-col items-center
         mt-2 md:ml-2 md:mr-3 ml-3 mr-3 pt-2 pb-3 rounded-2xl
         transition-transform duration-300 hover:scale-[1.02] hover:shadow-lg"
        >
         <slot name="headings" />
        </div>

        <FriendLink />
      </motion.div>
    </div>

    <!-- ä¸»ä½“å†…å®¹ -->
    <div
      class="flex-auto w-full md:w-8/12 ml-0.5 mr-0.5 overflow-scroll p-3 md:p-10 pb-16 md:pb-24"
      id="main-content"
      style="height: calc(100vh - 4rem)"
    >

      <motion.div
        client:load
        initial={{ opacity: 0, x: -50 }}
        animate={{ opacity: 1, x: 0 }}
        transition={{
          duration: 0.4,
        }}
      >
        <!-- æ–‡ç« å†…å®¹ -->
        <slot name="article" />

        <!-- ğŸ•“ æœ€åæ›´æ–°æ—¶é—´ï¼ˆæ¥è‡ª frontmatterï¼‰ -->
        {lastUpdated && (
          <div
            class="text-right text-sm text-fontLight dark:text-fontDark opacity-70 mt-6 select-none"
          >
            æœ€åæ›´æ–°æ—¶é—´ {lastUpdated}
          </div>
        )}

        <!-- ğŸ‘ï¸ é˜…è¯»æ¬¡æ•°æ˜¾ç¤º -->
        <div
          id="view-counter"
          class="text-right text-sm text-fontLight dark:text-fontDark opacity-70 mt-2 select-none"
        >
          æ­£åœ¨ç»Ÿè®¡é˜…è¯»æ¬¡æ•°...
        </div>
      </motion.div>
    </div>

    <!-- å³ä¾§ç•™ç™½ -->
    <div class="bg-bgLight dark:bg-bgDark hidden md:flex flex-auto w-2/12 justify-center">
      <p class="italic text-descriptionTextLight dark:text-descriptionTextDark">
        Posts grows here~
      </p>
    </div>
  </main>
</div>

<!-- ğŸ‘‡ é˜…è¯»æ¬¡æ•°ç»Ÿè®¡è„šæœ¬ï¼ˆå…³é—­ TS ç±»å‹æ£€æŸ¥ï¼‰ -->
<script lang="ts">
// @ts-nocheck

const pathParts = window.location.pathname.split('/');
const slug = pathParts.filter(Boolean).pop();

if (slug) {
  const lastViewKey = `viewed_${slug}`;
  const lastViewTime = localStorage.getItem(lastViewKey);
  const now = Date.now();

  const updateCounter = (views) => {
    const el = document.getElementById('view-counter');
    if (el) el.textContent = `é˜…è¯» ${views} æ¬¡`;
  };

  const showError = () => {
    const el = document.getElementById('view-counter');
    if (el) el.textContent = 'é˜…è¯»ç»Ÿè®¡åŠ è½½å¤±è´¥';
  };

  // âœ… é˜²æ­¢ 24 å°æ—¶å†…é‡å¤è®¡æ•°
  if (!lastViewTime || now - Number(lastViewTime) > 24 * 60 * 60 * 1000) {
    fetch(`/views/${slug}`)
      .then((res) => res.json())
      .then((data) => {
        if (data && typeof data.views === 'number') {
          updateCounter(data.views);
          localStorage.setItem(lastViewKey, now.toString());
        } else showError();
      })
      .catch(showError);
  } else {
    // 24 å°æ—¶å†…å·²è®¿é—®ï¼Œä»…åˆ·æ–°è®¡æ•°æ˜¾ç¤º
    fetch(`/views/${slug}`)
      .then((res) => res.json())
      .then((data) => {
        if (data && typeof data.views === 'number') updateCounter(data.views);
        else showError();
      })
      .catch(showError);
  }
}
</script>
