---
import FriendLink from '../components/friendLink.astro';
import '../styles/mathjax.css';
import '../styles/global.css';

// 从 Markdown frontmatter 读取属性
const { frontmatter } = Astro.props;
const publishDate = frontmatter.publishDate;
const {
  lastUpdated = publishDate,
  customStyle = null
} = frontmatter ?? {};

---

<head>
  <!-- 全局样式 -->
  <link rel="stylesheet" href="/styles/global.css" />
  <link rel="stylesheet" href="/styles/mathjax.css" />

  <!-- ⭐ 如果文章定义了 customStyle，就动态加载对应的 CSS ⭐ -->
  {customStyle && <link rel="stylesheet" href={customStyle} />}
</head>

<style>
/* ================================
   左侧目录滚动条（细线、圆角、美化）
   ================================ */
.left-toc::-webkit-scrollbar {
  width: 4px;
}
.left-toc::-webkit-scrollbar-thumb {
  background: rgba(120,120,120,0.35);
  border-radius: 8px;
}
.left-toc::-webkit-scrollbar-thumb:hover {
  background: rgba(120,120,120,0.55);
}
.left-toc::-webkit-scrollbar-track {
  background: transparent;
}
html.dark .left-toc::-webkit-scrollbar-thumb {
  background: rgba(180,180,180,0.25);
}
html.dark .left-toc::-webkit-scrollbar-thumb:hover {
  background: rgba(180,180,180,0.45);
}

/* ================================
   纯 CSS 进场动画
   ================================ */
.slide-in-left {
  opacity: 0;
  transform: translateX(-50px);
  animation: slide-in-left 0.4s ease-out forwards;
}
@keyframes slide-in-left {
  from {
    opacity: 0;
    transform: translateX(-50px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}
</style>

<div class="bg-bodyLight dark:bg-bodyDark flex flex-col overflow-hidden h-screen">
  <slot name="header" />

  <main class="flex flex-1">

    <!-- 左侧目录 -->
    <div
      class="bg-bgLight dark:bg-bgDark hidden md:flex flex-auto flex-col w-3/12 pl-16 left-toc overflow-y-auto"
      style="height: calc(100vh - 4rem)"
    >
      <div class="slide-in-left">
        <div
          class="bg-foilLight dark:bg-foilDark flex flex-col items-center
          mt-2 md:ml-2 md:mr-3 ml-3 mr-3 pt-2 pb-3 rounded-2xl
          transition-transform duration-300 hover:scale-[1.02] hover:shadow-lg"
        >
          <slot name="headings" />
        </div>

        <FriendLink />
      </div>
    </div>

    <!-- 中间内容区域 -->
    <div
      class="flex-auto w-full md:w-8/12 ml-0.5 mr-0.5 overflow-y-auto overflow-x-hidden p-3 md:p-10 pb-16 md:pb-24"
      id="main-content"
      style="height: calc(100vh - 4rem)"
    >

      <div class="slide-in-left">
        <!-- 文章内容 -->
        <slot name="article" />

        <!-- 更新时间 + 阅读次数 -->
        <div
          id="meta-info"
          class="text-right text-sm text-fontLight dark:text-fontDark opacity-70 mt-6 select-none"
        >
          {lastUpdated ? (
            <>
              最后更新时间 {lastUpdated}　
              <span id="view-counter">正在统计阅读次数...</span>
            </>
          ) : (
            <span id="view-counter">正在统计阅读次数...</span>
          )}
        </div>
      </div>
    </div>

    <!-- 右侧留白 -->
    <div class="bg-bgLight dark:bg-bgDark hidden md:flex flex-auto w-2/12 justify-center">
      <p class="italic text-descriptionTextLight dark:text-descriptionTextDark">
        Posts grows here~
      </p>
    </div>
  </main>
</div>

<!-- 阅读次数统计脚本 -->
<script>
// @ts-nocheck

const pathParts = window.location.pathname.split('/');
const slug = pathParts.filter(Boolean).pop();

if (slug) {
  const lastViewKey = `viewed_${slug}`;
  const lastViewTime = localStorage.getItem(lastViewKey);
  const now = Date.now();

  const updateCounter = (views) => {
    const el = document.getElementById('view-counter');
    if (el) el.textContent = `阅读 ${views} 次`;
  };

  const showError = () => {
    const el = document.getElementById('view-counter');
    if (el) el.textContent = '阅读统计加载失败';
  };

  // 24 小时内不重复计数
  if (!lastViewTime || now - Number(lastViewTime) > 24 * 60 * 60 * 1000) {
    fetch(`/views/${slug}`)
      .then((res) => res.json())
      .then((data) => {
        if (typeof data?.views === 'number') {
          updateCounter(data.views);
          localStorage.setItem(lastViewKey, now.toString());
        } else showError();
      })
      .catch(showError);
  } else {
    fetch(`/views/${slug}`)
      .then((res) => res.json())
      .then((data) => {
        if (typeof data?.views === 'number') updateCounter(data.views);
        else showError();
      })
      .catch(showError);
  }
}
</script>
