---
import FriendLink from '../components/friendLink.astro';
import '../styles/mathjax.css';
import '../styles/global.css';

// ä» Markdown frontmatter ç›´æ¥è§£æ„ propsï¼ˆé€šè¿‡ posts/[id].astro ä¼ å…¥ï¼‰
const { lastUpdated, customStyle } = Astro.props as {
  lastUpdated?: string;
  customStyle?: string;
};
---

<!-- ğŸ”— å¦‚æœæœ‰ customStyleï¼Œå°±æŠŠå®ƒæ’å…¥åˆ° <head>ï¼Œåªå¯¹å½“å‰é¡µé¢ç”Ÿæ•ˆ -->
<head>
  {customStyle && <link rel="stylesheet" href={customStyle} />}
</head>

<style>
/* ================================
   å·¦ä¾§ç›®å½•æ»šåŠ¨æ¡ï¼ˆç»†çº¿ã€åœ†è§’ã€ç¾åŒ–ï¼‰
   ================================ */
.left-toc::-webkit-scrollbar {
  width: 4px;
}
.left-toc::-webkit-scrollbar-thumb {
  background: rgba(120,120,120,0.35);
  border-radius: 8px;
}
.left-toc::-webkit-scrollbar-thumb:hover {
  background: rgba(120,120,120,0.55);
}
.left-toc::-webkit-scrollbar-track {
  background: transparent;
}

/* æš—é»‘æ¨¡å¼æ»šåŠ¨æ¡é€‚é… */
html.dark .left-toc::-webkit-scrollbar-thumb {
  background: rgba(180,180,180,0.25);
}
html.dark .left-toc::-webkit-scrollbar-thumb:hover {
  background: rgba(180,180,180,0.45);
}

/* ================================
   çº¯ CSS è¿›åœºåŠ¨ç”»ï¼ˆæ›¿ä»£ motionï¼‰
   ================================ */
.slide-in-left {
  opacity: 0;
  transform: translateX(-50px);
  animation: slide-in-left 0.4s ease-out forwards;
}

@keyframes slide-in-left {
  from {
    opacity: 0;
    transform: translateX(-50px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}
</style>

<div class="bg-bodyLight dark:bg-bodyDark flex flex-col overflow-hidden h-screen">
  <slot name="header" />
  <main class="flex flex-1">
    <!-- å·¦ä¾§ç›®å½•ï¼ˆç»†çº¿æ»šåŠ¨æ¡ + CSS åŠ¨ç”»ï¼‰ -->
    <div
      class="bg-bgLight dark:bg-bgDark hidden md:flex flex-auto flex-col w-3/12 pl-16 left-toc overflow-y-auto"
      style="height: calc(100vh - 4rem)"
    >
      <div class="slide-in-left">
        <div
          class="bg-foilLight dark:bg-foilDark flex flex-col items-center
          mt-2 md:ml-2 md:mr-3 ml-3 mr-3 pt-2 pb-3 rounded-2xl
          transition-transform duration-300 hover:scale-[1.02] hover:shadow-lg"
        >
          <slot name="headings" />
        </div>

        <FriendLink />
      </div>
    </div>

    <!-- ä¸»ä½“å†…å®¹ï¼ˆåªçºµå‘æ»šåŠ¨ï¼Œå»æ‰æ¨ªå‘æ»šåŠ¨æ¡ï¼‰ -->
    <div
      class="flex-auto w-full md:w-8/12 ml-0.5 mr-0.5 overflow-y-auto overflow-x-hidden p-3 md:p-10 pb-16 md:pb-24"
      id="main-content"
      style="height: calc(100vh - 4rem)"
    >
      <div class="slide-in-left">
        <!-- æ–‡ç« å†…å®¹ -->
        <slot name="article" />

        <!-- æœ€åæ›´æ–°æ—¶é—´ + é˜…è¯»æ¬¡æ•° -->
        <div
          id="meta-info"
          class="text-right text-sm text-fontLight dark:text-fontDark opacity-70 mt-6 select-none"
        >
          {lastUpdated ? (
            <>
              æœ€åæ›´æ–°æ—¶é—´ {lastUpdated}ã€€
              <span id="view-counter">æ­£åœ¨ç»Ÿè®¡é˜…è¯»æ¬¡æ•°...</span>
            </>
          ) : (
            <span id="view-counter">æ­£åœ¨ç»Ÿè®¡é˜…è¯»æ¬¡æ•°...</span>
          )}
        </div>
      </div>
    </div>

    <!-- å³ä¾§ç•™ç™½ -->
    <div class="bg-bgLight dark:bg-bgDark hidden md:flex flex-auto w-2/12 justify-center">
      <p class="italic text-descriptionTextLight dark:text-descriptionTextDark">
        Posts grows here~
      </p>
    </div>
  </main>
</div>

<!-- é˜…è¯»æ¬¡æ•°ç»Ÿè®¡è„šæœ¬ -->
<script lang="ts">
// @ts-nocheck

const pathParts = window.location.pathname.split('/');
const slug = pathParts.filter(Boolean).pop();

if (slug) {
  const lastViewKey = `viewed_${slug}`;
  const lastViewTime = localStorage.getItem(lastViewKey);
  const now = Date.now();

  const updateCounter = (views) => {
    const el = document.getElementById('view-counter');
    if (el) el.textContent = `ã€€ã€€é˜…è¯» ${views} æ¬¡`;
  };

  const showError = () => {
    const el = document.getElementById('view-counter');
    if (el) el.textContent = 'é˜…è¯»ç»Ÿè®¡åŠ è½½å¤±è´¥';
  };

  // 24 å°æ—¶å†…é˜²é‡å¤è®¡æ•°
  if (!lastViewTime || now - Number(lastViewTime) > 24 * 60 * 60 * 1000) {
    fetch(`/views/${slug}`)
      .then((res) => res.json())
      .then((data) => {
        if (data && typeof data.views === 'number') {
          updateCounter(data.views);
          localStorage.setItem(lastViewKey, now.toString());
        } else showError();
      })
      .catch(showError);
  } else {
    // å·²è®¿é—®ï¼Œä»…åˆ·æ–°æ˜¾ç¤º
    fetch(`/views/${slug}`)
      .then((res) => res.json())
      .then((data) => {
        if (data && typeof data.views === 'number') updateCounter(data.views);
        else showError();
      })
      .catch(showError);
  }
}
</script>
